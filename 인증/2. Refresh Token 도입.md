# Refresh Token 도입

https://tecoble.techcourse.co.kr/post/2021-10-20-refresh-token/

보안을 위해 ACCESS TOKEN 의 유효기간을 짧게 잡았을 경우 발생하는 문제는 짧은 시간마다 사용자가 로그인을 다시 해야한다는 점이다. 특히 글쓰기 화면에서 토큰 유효 시간보다 길게 머무르면서 글을 쓸 경우, 작성한 글이 모두 날아가 매우 치명적이다.

### ACCESS TOKEN 만료 기간 연장할 경우

ACCESS TOKEN 은 JWT 이므로 그 자체로 인증 정보를 모두 가지고 있어 탈취되면 매우 위험한 상황이 발생할 수 있으므로, ACCESS TOKEN 의 만료기간을 늘릴 경우 보안상 큰 문제가 된다.

### XSS 와 CSRF 를 잘 막아둔다고 가정할 경우

XSS 와 CSRF 는 웹에서 발생하는 가장 대표적인 취약점이다. XSS 는 자바스크립트 코드를 사용자 브라우저에서 실행하여 악의적인 작업을 수행하는 공격이고, CSRF 는 사용자 브라우저에서 어떤 API 로의 요청을 강제함으로써 사용자가 의도하지 않은 작업을 수행하는 공격을 의미한다.

항상 보안 취약점이 없다고 생각하는 것은 위험한 생각이다. React 를 사용하면 XSS 공격을 방지해주고, localStorage 를 사용하면 CSRF 취약점을 막아주지만, 이것이 항상 통한다고 생각하면 안된다. 항상 예측할 수 없는 보안 취약점이 생길 수 있으므로, 탈취되었을 때를 가정하고 가장 덜 치명적인 방향으로 개발해야 한다.

## Refresh Token

Refresh Token 은 Access Token 을 재발급 받을 수 있는 토큰이다. 이 토큰은 서버에 저장되기 때문에 Refresh Token 이 해커에 의해 탈취되었다고 판단되었을 때 서버에서 Refresh Token 을 삭제함으로써 강제 로그아웃 시킬 수 있다.

### 시나리오 1: Refresh Token 을 프론트 서버의 session 에 저장하는 경우

Refresh Token 과 Access Token 을 프론트 서버의 session 에 저장해두고, 클라이언트가 토큰이 저장된 세션에 접근하기 위해 session id 를 쿠키로 가지고 있는 방식이다.

#### 장점

- 새로고침 상황에서 백엔드 서버까지 요청이 전달되지 않아도 된다.<br/>프론트 서버 session 에 Refresh Token 과 Access Token 이 사용자마다 저장되어있기 때문에 Access Token 을 얻기 위해 추가로 백엔드 서버로 요청을 보낼 필요가 없다. 요청 횟수에서 경제적이다.
- Access Token 재활용이 가능하다.<br/>Refresh Token 을 백엔드 서버에 저장하는 경우 새로고침했을 때 Access Token 만료 기간이 한참 남았음에도 Access Token 을 재발급한다. 왜냐하면, 프론트 서버를 거쳐 백엔드 서버에까지 이미 요청이 도달했기 때문에 Access Token 을 재활용하는 것보다 재발급하는 것이 오히려 경제적일 수 있기 때문이다. 하지만 프론트 서버의 session 에 토큰을 저장하는 경우, 토큰을 얻기 위한 요청이 백엔드 서버까지 전달될 필요가 없기 때문에 Access Token 을 재활용함으로써 비용을 절약할 수 있다.

#### 단점

- 사용자가 많아질 때 session 관리가 힘들다.<br/>사용자가 많아지게 되면 하나의 WAS(Web Application Server) 를 여러개의 WAS 로 나누어 사용량을 분배해야 한다. 그럼 session 도 WAS 마다 생겨나게 되는데, 브라우저 입장에서 정보를 요청할 때 적절한 WAS 의 session 에 접근할 수 있도록 웹 서버에서 잘 연결해주어야 한다.

### 시나리오 2: Refresh Token 을 백엔드 서버에 저장하는 경우

Refresh Token 을 백엔드 서버에 저장해두고 클라이언트는 Refresh Token 에 대한 정보를 쿠키로 가지고 있는 방식이다.

#### 장점

- 서버 이슈를 백엔드 서버에서 대부분 처리하기 때문에 관리에 용이하다.<br/>사용자가 많아짐에 따라 생기는 서버 이슈를 백엔드에서 모두 처리하기 때문에 관리 포인트가 프론트 서버, 백엔드 서버 둘로 나뉘지 않고 백엔드 서버 한곳에서 처리되어 이슈 관리에 용이하다.

#### 단점

- 새로고침하면 항상 백엔드 서버까지 요청이 전달된다.<br/>토큰이 프론트서버에 따로 저장되지 않기 때문에 Acess Token 을 얻기 위해서는 항상 백엔드 서버까지 요청이 전달되어야 한다. 요청 횟수, 요청에 드는 비용 등을 고려했을 때 비효율적일 수 있다.

## 추가 고려 사항

### 보안: 정상적인 사용자의 IP 가 아니라면 Refresh Token 삭제

Refresh Token 은 서버에 저장되기 때문에 보안적인 문제가 발생했을 때 Refresh Token 을 삭제함으로써 특정 사용자를 강제 로그아웃 시킬 수 있다. 이를 이용하여 처음 로그인한 IP 를 서버에 저장하고, Refresh Token 을 통한 Access Token 갱신 요청이 다른 IP 로부터 온다면 비정상적인 접근이라고 판단하고 Refresh Token 을 삭제하여 강제 로그아웃시킬 수 있다.

하지만 이 방식은 UX 적인 단점이 있다. 요즘에 들어서는 한 곳에서만 컴퓨터를 사용하지 않기 때문에(카페 등에서 노트북 이용 등) 장소가 바뀌어 IP 가 달라졌다고 해서 로그아웃시킨다면 사용자 경험에 좋지 않다.

네이버 등에서는 IP 가 달라지는 경우 보안 알림을 사용자에게 띄워주고, 여기서 본인의 사용인지 아닌지를 구분하여 본인의 사용이 아니라면 강제로 로그아웃시킬 수 있도록 하고있다.

### UX: 사용중에 Access Token 이 만료된다면 조용히 재발급

Access Token 의 유효기간이 2시간일 때, 어떤 한 사용자가 2시간동안 새로고침하지 않고 글쓰기 화면에서 머무른다고 해도, Access Token 이 만료되었다는 사실을 사용자가 모르게 하는 것이 가장 좋다.

#### **방법1: 요청 보낼 때 토큰 만료 에러가 발생하면 토큰을 새로 발급**

인가가 필요한 요청을 보낼 때 토큰 만료 에러가 발생하면 토큰을 새로 발급받고, 새로 받은 토큰으로 다시 요청을 보낸다.

#### 장점

- 사용자가 인가가 필요한 작업을 요청할 때에만 토큰이 재발급되어 경제적이다.

#### 단점

- 인가가 필요한 요청에 대한 에러처리, 재요청 로직이 추가 요구된다.
- 토큰이 만료된 경우 인가가 필요한 요청을 두번 보내야 한다.

#### **방법2: 일정 시간마다 새로운 Access Token 발급 받기**

Access Token 만료 기간이 되기 전에 토큰을 재발급받도록 할 수 있다.

#### 장점

- setTimeout 으로 토큰 재발급 로직만 작성해주면 요청 관련 로직 수정이 필요 없다.

#### 단점

- 시간과 관련하여 토큰을 재발급받기 때문에 특정 시간이 지나면 무조건 재발급 요청을 보내어 비효율적일 수 있다.
