## 비디오 업로드 FORM

### Dropzone 설치

비디오 등의 파일을 업로드하기 위해 Dropzone 라이브러리를 이용하기로 한다.

```
> npm install dropzone --save
```

### 비디오 업로드 페이지 작성

#### 기본 템플릿 작성

빠른 웹 개발을 위하여 ant design 을 이용하여 작성하도록 한다.

src/components/views/VideoUploadPage/VideoUploadPage.js 파일을 만들고 내부에 업로드 페이지의 Form 형태를 갖추어 준다.

```
// src/components/views/VideoUploadPage/VideoUploadPage.js
import React from "react";
import { Typography, Button, Form, message, Input } from "antd";
import Dropzone from "react-dropzone";
import { AiOutlinePlus } from "react-icons/ai";

const { Title } = Typography;
const { TextArea } = Input;

function VideoUploadPage() {
  return (
    <div style={{ maxWidth: "700px", margin: "2rem auto" }}>
      <div style={{ textAlign: "center", marginBottom: "2rem" }}>
        <Title level={2}>Upload Video</Title>
      </div>
      <Form onDrop multiple maxSize>
        <div style={{ display: "flex", justifyContent: "space-between" }}>
          {/* Drop Zone */}
          <Dropzone>
            {({ getRootProps, getInputProps }) => (
              <div style={{ display: "flex", width: "300px", height: "240px", border: "1px solid lightgray", alignItems: "center", justifyContent: "center" }} {...getRootProps()}>
                <input {...getInputProps()} />
                <AiOutlinePlus style={{ fontSize: "3rem" }} />
              </div>
            )}
          </Dropzone>
          {/* Thumbnail */}
          <div>
            <img src alt="" />
          </div>
        </div>
        <br />
        <br />
        <label>Title</label>
        <Input onChange value />
        <br />
        <br />
        <label>Description</label>
        <TextArea onChange value />
        <br />
        <br />
        <select onChange>
          <option key value></option>
        </select>
        <br />
        <br />
        <select onChange>
          <option key value></option>
        </select>
        <br />
        <br />
        <Button type="primary" size="large" onClick>
          Submit
        </Button>
      </Form>
    </div>
  );
}

export default VideoUploadPage;
```

아직 내부 Form 작성했을 때 작동하는 함수나 제출 기능은 구현되지 않은 형태이다.

추가적으로 업로드 페이지를 열 수 있도록 App.js 파일에서 라우트 설정을 해준다.

```
// src/components/App.js

import VideoUploadPage from ' ... ';

const AuthVideoUploadPage = auth(VideoUploadPage, true)

<Route exact path='/video/upload element={<AuthVideoUploadPage />} />
```

위의 세 문구를 적당한 위치에 입력하면 업로드 페이지에 접근이 가능해진다.

#### 입력값 state 처리

이전 과정에서 진행한 것과 같이 input 에 입력받은 것을 state로 저장할 수 있도록 state를 새로 작성하고, onChnage 함수를 각각 만들어 적용해주도록 한다.

카테고리를 선택하는 버튼은 아래와 같이 만들 수 있다.

```
// src/components/views/VideoUploadPage/VideoUploadPage.js
const PrivateOption = [
  { value: 0, label: "Private" },
  { value: 1, label: "Public" },
];

const CategoryOption = [
  { value: 0, label: "Film & Animation" },
  { value: 1, label: "Autos & Vehicles" },
  { value: 2, label: "Music" },
  { value: 3, label: "Pets & Animals" },
];

function VideoUploadPage() {
  const [Private, setPrivate] = useState(0);
  const [Category, setCategory] = useState("Film & Animation");


  const onPrivateChange = (e) => {
    setPrivate(e.currentTarget.value);
  };

  const onCategoryChange = (e) => {
    setCategory(e.currentTarget.value);
  };
  
  ...

  return (
    ...

        <select onChange={onPrivateChange}>
          {PrivateOption.map((item, index) => (
            <option key={index} value={item.value}>
              {item.label}
            </option>
          ))}
        </select>
        <br />
        <br />
        <select onChange={onCategoryChange}>
          {CategoryOption.map((item, index) => (
            <option key={index} value={item.value}>
              {item.label}
            </option>
          ))}
        </select>

    ...
  )
}
```

기존의 텍스트 입력 창과 유사하게 onChnage 를 이용하여 state 에 값을 저장하는 것은 동일하지만, 선택할 수 있는 옵션들을 미리 저장하고, 이를 select 및 option 기능을 이용하여 구현해준다.

### MULTER 설치

MULTER 는 노드 서버쪽에서 파일을 받아 저장할 수 있도록 처리해주는 라이브러리이다.

```
> npm install multer --save
```

### video 처리 라우터 작성

서버쪽에 비디오 관련하여 클라이언트에서 요청이 왔을 시, 이에 대한 처리를 할 라우터를 작성해준다.

```
// routes/videos.js
const express = require("express");
const router = express.Router();
const { Video } = require("../models/Video");
const { auth } = require("../middleware/auth");
const multer = require("multer");

// MULTER CONFIG
let storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, "uploads/");
  },
  filename: (req, file, cb) => {
    cb(null, `${Date.now()}_${file.originalname}`);
  },
  fileFilter: (req, file, cb) => {
    const ext = path.extname(file.originalname);
    if (ext !== ".mp4") {
      return cb(res.status(400).end("only mp4 is allowed"), false);
    }
    cb(null, true);
  },
});

const upload = multer({ storage: storage }).single("file");

// FILE UPLOAD ROUTER
router.post("/uploadfiles", (req, res) => {
  // 클라이언트에서 받은 파일 서버에 저장
  upload(req, res, (err) => {
    if (err) {
      return res.json({ success: false, err });
    }
    return res.json({ success: true, url: res.req.file.path, fileName: res.req.file.filename });
  });
});

module.exports = router;
```

multer 를 불러와주고, multer 가 처리해줄 파일에 대한 저장 위치, 파일 이름, 확장자에 대한 설정을 해준다.

저장 위치는 /uploads 즉, 서버 루트 폴더의 uploads 폴더에 저장하도록 하고, 파일 이름 관련해서는 현재의 날짜에 전송받은 파일의 원래 이름을 붙여 저장해준다.

그리고 파일 형식은 일단 mp4 파일이 아니라면 업로드 할 수 없도록 설정해준다.

그리고 upload 함수로 받은 파일을 multer storage 에 저장하도록 하고,

/api/video/uploadfiles 로 받은 파일 요청에 대하여 서버에 업로드 후에 그 결과를 응답해주는 라우터를 작성한다.

원래는 먼저 비디오 모델이 필요하지만 일단 미루고 index.js 에 라우터를 등록해준다.

```
// index.js
app.use("/api/video", require("./routes/videos"));
```

이제 클라이언트에서 + 버튼을 눌러 파일을 불러오면, 서버측 폴더에 파일이 저장되고, 그 url 과 파일 이름이 응답으로 콘솔에 표시되는 것을 확인할 수 있다.